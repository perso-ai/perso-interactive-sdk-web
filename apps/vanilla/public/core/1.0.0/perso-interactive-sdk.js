var PersoInteractive=function(D){"use strict";class u extends Error{constructor(){super("WebRTC connection timeout")}}class t extends Error{errorCode;code;detail;attr;constructor(D,u,t,e){let F;F=null!=e?`${D}:${e}_${t}`:`${D}:${t}`,super(F),this.errorCode=D,this.code=u,this.detail=t,this.attr=e}}class e extends Error{underlyingError;constructor(D){super(),this.underlyingError=D}}class F extends Error{description;constructor(D){super(),this.description=D}}class s{static async getLLMs(D,u){const t=fetch(`${D}/api/v1/settings/llm_type/`,{headers:{"PersoLive-APIKey":u},method:"GET"}),e=await t;return await this.parseJson(e)}static async getModelStyles(D,u){const t=fetch(`${D}/api/v1/settings/modelstyle/?platform_type=webrtc`,{headers:{"PersoLive-APIKey":u},method:"GET"}),e=await t;return await this.parseJson(e)}static async getBackgroundImages(D,u){const t=fetch(`${D}/api/v1/background_image/`,{headers:{"PersoLive-APIKey":u},method:"GET"}),e=await t;return await this.parseJson(e)}static async getTTSs(D,u){const t=fetch(`${D}/api/v1/settings/tts_type/`,{headers:{"PersoLive-APIKey":u},method:"GET"}),e=await t;return await this.parseJson(e)}static async getSTTs(D,u){const t=fetch(`${D}/api/v1/settings/stt_type/`,{headers:{"PersoLive-APIKey":u},method:"GET"}),e=await t;return await this.parseJson(e)}static async getPrompts(D,u){const t=fetch(`${D}/api/v1/prompt/`,{headers:{"PersoLive-APIKey":u},method:"GET"}),e=await t;return await this.parseJson(e)}static async getDocuments(D,u){const t=fetch(`${D}/api/v1/document/`,{headers:{"PersoLive-APIKey":u},method:"GET"}),e=await t;return await this.parseJson(e)}static async getMcpServers(D,u){const t=fetch(`${D}/api/v1/settings/mcp_type/`,{headers:{"PersoLive-APIKey":u},method:"GET"}),e=await t;return await this.parseJson(e)}static async getSessionInfo(D,u){const t=fetch(`${D}/api/v1/session/${u}/`,{method:"GET"}),e=await t;return await this.parseJson(e)}static async sessionEvent(D,u,t){const e=fetch(`${D}/api/v1/session/${u}/event/create/`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({detail:"",event:t})});await e}static async parseJson(D){const u=await D.json();if(D.ok)return u;throw new t(D.status,u.errors[0].code,u.errors[0].detail,u.errors[0].attr)}}var a;class C extends EventTarget{pc;dc;streams=[];pingTime;pingIntervalId=null;constructor(D,u){super(),this.pc=D,this.dc=u,this.pingTime=Date.now()+3e3,this.pc.addEventListener("track",D=>{this.streams=this.streams.concat(D.streams)}),this.pc.addEventListener("connectionstatechange",()=>{"disconnected"!==this.pc.connectionState&&"failed"!==this.pc.connectionState||this.close()}),this.dc.onopen=()=>{this.pingIntervalId=setInterval(()=>{this.ping(),Date.now()-this.pingTime>5e3&&this.close()},1e3)},this.dc.onclose=()=>{null!=this.pingIntervalId&&clearInterval(this.pingIntervalId)},this.#D({live:!0,code:200,reason:"OK"}),this.setMessageCallback("ping",()=>{this.pingTime=Date.now()})}static async create(D,u,t,e,F){const a=await fetch(`${D}/api/v1/session/${u}/ice-servers/`,{method:"GET"}),n=(await s.parseJson(a)).ice_servers;let i=await C.createPeerConnection(n),E=i.createDataChannel("message",{protocol:"message"}),r=new C(i,E);t.getTracks().forEach(function(D){i.addTrack(D,t)});const o=i.addTransceiver("video",{direction:"recvonly"}),c=RTCRtpReceiver.getCapabilities("video");null!=c&&o.setCodecPreferences(c.codecs.filter(D=>"video/VP8"===D.mimeType));const l=await i.createOffer();await i.setLocalDescription(l);const h=await fetch(`${D}/api/v1/session/${u}/exchange/`,{body:JSON.stringify({client_sdp:l}),headers:{"Content-Type":"application/json"},method:"POST"}),B=await s.parseJson(h);return await i.setRemoteDescription(B.server_sdp),await C.waitFor(()=>r.isReady(),100,50),r.changeSize(e,F),r}static async createPeerConnection(D){return new RTCPeerConnection({sdpSemantics:"unified-plan",iceServers:D})}static async waitFor(D,t,e){let F=0;if(await new Promise(u=>{const s=setInterval(()=>{F+=1,F>=e&&(clearInterval(s),u("bad")),D()&&(clearInterval(s),u("good"))},t)}),F>=e)throw new u}isReady(){return this.streams.length>0&&"open"===this.dc.readyState}#D(D){this.dispatchEvent(new CustomEvent("status",{detail:D}))}subscribeStatus(D){return this.addEventListener("status",D),()=>{this.removeEventListener("status",D)}}getStream(){return this.streams[0]}sendMessage(D,u){this.dc.send(JSON.stringify({type:D,data:u}))}ttstf(D){this.sendMessage("ttstf",{message:D})}recordStart(){this.sendMessage("record-start",{})}recordEndStt(D){this.sendMessage("record-end-stt",{language:D})}recordEndTranslate(D,u){this.sendMessage("record-end-translate",{src_lang:D,dst_lang:u})}changeSize(D,u){this.sendMessage("change-size",{width:D,height:u})}setTemplate(D,u){this.sendMessage("set-template",{model:D,dress:u})}clearBuffer(){this.sendMessage("clear-buffer",{})}ping(){this.sendMessage("ping",{})}setMessageCallback(D,u){const t=t=>{const e=JSON.parse(t.data);e.type===D&&u(e.data)};return this.dc.addEventListener("message",t),()=>{this.dc.removeEventListener("message",t)}}close(){this.dc.close(),this.pc.close(),this.#D({live:!1,code:408,reason:"Request Timeout"})}closeSelf(){this.dc.close(),this.pc.close(),this.#D({live:!1,code:200,reason:"OK"})}}D.ChatState=void 0,(a=D.ChatState||(D.ChatState={})).RECORDING="RECORDING",a.LLM="LLM",a.ANALYZING="ANALYZING",a.SPEAKING="SPEAKING";class n{apiServer;sessionId;stream;perso;clientTools;chatStatesHandler=new EventTarget;chatLogHandler=new EventTarget;sttEventHandler=null;errorHandler=new EventTarget;lastStfTimeoutHandle=null;stfTotalDuration=0;stfTimeoutStartTime=0;messageHistory=[];chatLog=[];chatStateMap=new Map([[D.ChatState.RECORDING,0],[D.ChatState.LLM,0],[D.ChatState.ANALYZING,0],[D.ChatState.SPEAKING,0]]);emojiRegex=/[#*0-9]\uFE0F?\u20E3|[\xA9\xAE\u203C\u2049\u2122\u2139\u2194-\u2199\u21A9\u21AA\u231A\u231B\u2328\u23CF\u23ED-\u23EF\u23F1\u23F2\u23F8-\u23FA\u24C2\u25AA\u25AB\u25B6\u25C0\u25FB\u25FC\u25FE\u2600-\u2604\u260E\u2611\u2614\u2615\u2618\u2620\u2622\u2623\u2626\u262A\u262E\u262F\u2638-\u263A\u2640\u2642\u2648-\u2653\u265F\u2660\u2663\u2665\u2666\u2668\u267B\u267E\u267F\u2692\u2694-\u2697\u2699\u269B\u269C\u26A0\u26A7\u26AA\u26B0\u26B1\u26BD\u26BE\u26C4\u26C8\u26CF\u26D1\u26E9\u26F0-\u26F5\u26F7\u26F8\u26FA\u2702\u2708\u2709\u270F\u2712\u2714\u2716\u271D\u2721\u2733\u2734\u2744\u2747\u2757\u2763\u27A1\u2934\u2935\u2B05-\u2B07\u2B1B\u2B1C\u2B55\u3030\u303D\u3297\u3299]\uFE0F?|[\u261D\u270C\u270D](?:\uD83C[\uDFFB-\uDFFF]|\uFE0F)?|[\u270A\u270B](?:\uD83C[\uDFFB-\uDFFF])?|[\u23E9-\u23EC\u23F0\u23F3\u25FD\u2693\u26A1\u26AB\u26C5\u26CE\u26D4\u26EA\u26FD\u2705\u2728\u274C\u274E\u2753-\u2755\u2795-\u2797\u27B0\u27BF\u2B50]|\u26D3\uFE0F?(?:\u200D\uD83D\uDCA5)?|\u26F9(?:\uD83C[\uDFFB-\uDFFF]|\uFE0F)?(?:\u200D[\u2640\u2642]\uFE0F?)?|\u2764\uFE0F?(?:\u200D(?:\uD83D\uDD25|\uD83E\uDE79))?|\uD83C(?:[\uDC04\uDD70\uDD71\uDD7E\uDD7F\uDE02\uDE37\uDF21\uDF24-\uDF2C\uDF36\uDF7D\uDF96\uDF97\uDF99-\uDF9B\uDF9E\uDF9F\uDFCD\uDFCE\uDFD4-\uDFDF\uDFF5\uDFF7]\uFE0F?|[\uDF85\uDFC2\uDFC7](?:\uD83C[\uDFFB-\uDFFF])?|[\uDFC4\uDFCA](?:\uD83C[\uDFFB-\uDFFF])?(?:\u200D[\u2640\u2642]\uFE0F?)?|[\uDFCB\uDFCC](?:\uD83C[\uDFFB-\uDFFF]|\uFE0F)?(?:\u200D[\u2640\u2642]\uFE0F?)?|[\uDCCF\uDD8E\uDD91-\uDD9A\uDE01\uDE1A\uDE2F\uDE32-\uDE36\uDE38-\uDE3A\uDE50\uDE51\uDF00-\uDF20\uDF2D-\uDF35\uDF37-\uDF43\uDF45-\uDF4A\uDF4C-\uDF7C\uDF7E-\uDF84\uDF86-\uDF93\uDFA0-\uDFC1\uDFC5\uDFC6\uDFC8\uDFC9\uDFCF-\uDFD3\uDFE0-\uDFF0\uDFF8-\uDFFF]|\uDDE6\uD83C[\uDDE8-\uDDEC\uDDEE\uDDF1\uDDF2\uDDF4\uDDF6-\uDDFA\uDDFC\uDDFD\uDDFF]|\uDDE7\uD83C[\uDDE6\uDDE7\uDDE9-\uDDEF\uDDF1-\uDDF4\uDDF6-\uDDF9\uDDFB\uDDFC\uDDFE\uDDFF]|\uDDE8\uD83C[\uDDE6\uDDE8\uDDE9\uDDEB-\uDDEE\uDDF0-\uDDF7\uDDFA-\uDDFF]|\uDDE9\uD83C[\uDDEA\uDDEC\uDDEF\uDDF0\uDDF2\uDDF4\uDDFF]|\uDDEA\uD83C[\uDDE6\uDDE8\uDDEA\uDDEC\uDDED\uDDF7-\uDDFA]|\uDDEB\uD83C[\uDDEE-\uDDF0\uDDF2\uDDF4\uDDF7]|\uDDEC\uD83C[\uDDE6\uDDE7\uDDE9-\uDDEE\uDDF1-\uDDF3\uDDF5-\uDDFA\uDDFC\uDDFE]|\uDDED\uD83C[\uDDF0\uDDF2\uDDF3\uDDF7\uDDF9\uDDFA]|\uDDEE\uD83C[\uDDE8-\uDDEA\uDDF1-\uDDF4\uDDF6-\uDDF9]|\uDDEF\uD83C[\uDDEA\uDDF2\uDDF4\uDDF5]|\uDDF0\uD83C[\uDDEA\uDDEC-\uDDEE\uDDF2\uDDF3\uDDF5\uDDF7\uDDFC\uDDFE\uDDFF]|\uDDF1\uD83C[\uDDE6-\uDDE8\uDDEE\uDDF0\uDDF7-\uDDFB\uDDFE]|\uDDF2\uD83C[\uDDE6\uDDE8-\uDDED\uDDF0-\uDDFF]|\uDDF3\uD83C[\uDDE6\uDDE8\uDDEA-\uDDEC\uDDEE\uDDF1\uDDF4\uDDF5\uDDF7\uDDFA\uDDFF]|\uDDF4\uD83C\uDDF2|\uDDF5\uD83C[\uDDE6\uDDEA-\uDDED\uDDF0-\uDDF3\uDDF7-\uDDF9\uDDFC\uDDFE]|\uDDF6\uD83C\uDDE6|\uDDF7\uD83C[\uDDEA\uDDF4\uDDF8\uDDFA\uDDFC]|\uDDF8\uD83C[\uDDE6-\uDDEA\uDDEC-\uDDF4\uDDF7-\uDDF9\uDDFB\uDDFD-\uDDFF]|\uDDF9\uD83C[\uDDE6\uDDE8\uDDE9\uDDEB-\uDDED\uDDEF-\uDDF4\uDDF7\uDDF9\uDDFB\uDDFC\uDDFF]|\uDDFA\uD83C[\uDDE6\uDDEC\uDDF2\uDDF3\uDDF8\uDDFE\uDDFF]|\uDDFB\uD83C[\uDDE6\uDDE8\uDDEA\uDDEC\uDDEE\uDDF3\uDDFA]|\uDDFC\uD83C[\uDDEB\uDDF8]|\uDDFD\uD83C\uDDF0|\uDDFE\uD83C[\uDDEA\uDDF9]|\uDDFF\uD83C[\uDDE6\uDDF2\uDDFC]|\uDF44(?:\u200D\uD83D\uDFEB)?|\uDF4B(?:\u200D\uD83D\uDFE9)?|\uDFC3(?:\uD83C[\uDFFB-\uDFFF])?(?:\u200D(?:[\u2640\u2642]\uFE0F?(?:\u200D\u27A1\uFE0F?)?|\u27A1\uFE0F?))?|\uDFF3\uFE0F?(?:\u200D(?:\u26A7\uFE0F?|\uD83C\uDF08))?|\uDFF4(?:\u200D\u2620\uFE0F?|\uDB40\uDC67\uDB40\uDC62\uDB40(?:\uDC65\uDB40\uDC6E\uDB40\uDC67|\uDC73\uDB40\uDC63\uDB40\uDC74|\uDC77\uDB40\uDC6C\uDB40\uDC73)\uDB40\uDC7F)?)|\uD83D(?:[\uDC3F\uDCFD\uDD49\uDD4A\uDD6F\uDD70\uDD73\uDD76-\uDD79\uDD87\uDD8A-\uDD8D\uDDA5\uDDA8\uDDB1\uDDB2\uDDBC\uDDC2-\uDDC4\uDDD1-\uDDD3\uDDDC-\uDDDE\uDDE1\uDDE3\uDDE8\uDDEF\uDDF3\uDDFA\uDECB\uDECD-\uDECF\uDEE0-\uDEE5\uDEE9\uDEF0\uDEF3]\uFE0F?|[\uDC42\uDC43\uDC46-\uDC50\uDC66\uDC67\uDC6B-\uDC6D\uDC72\uDC74-\uDC76\uDC78\uDC7C\uDC83\uDC85\uDC8F\uDC91\uDCAA\uDD7A\uDD95\uDD96\uDE4C\uDE4F\uDEC0\uDECC](?:\uD83C[\uDFFB-\uDFFF])?|[\uDC6E-\uDC71\uDC73\uDC77\uDC81\uDC82\uDC86\uDC87\uDE45-\uDE47\uDE4B\uDE4D\uDE4E\uDEA3\uDEB4\uDEB5](?:\uD83C[\uDFFB-\uDFFF])?(?:\u200D[\u2640\u2642]\uFE0F?)?|[\uDD74\uDD90](?:\uD83C[\uDFFB-\uDFFF]|\uFE0F)?|[\uDC00-\uDC07\uDC09-\uDC14\uDC16-\uDC25\uDC27-\uDC3A\uDC3C-\uDC3E\uDC40\uDC44\uDC45\uDC51-\uDC65\uDC6A\uDC79-\uDC7B\uDC7D-\uDC80\uDC84\uDC88-\uDC8E\uDC90\uDC92-\uDCA9\uDCAB-\uDCFC\uDCFF-\uDD3D\uDD4B-\uDD4E\uDD50-\uDD67\uDDA4\uDDFB-\uDE2D\uDE2F-\uDE34\uDE37-\uDE41\uDE43\uDE44\uDE48-\uDE4A\uDE80-\uDEA2\uDEA4-\uDEB3\uDEB7-\uDEBF\uDEC1-\uDEC5\uDED0-\uDED2\uDED5-\uDED8\uDEDC-\uDEDF\uDEEB\uDEEC\uDEF4-\uDEFC\uDFE0-\uDFEB\uDFF0]|\uDC08(?:\u200D\u2B1B)?|\uDC15(?:\u200D\uD83E\uDDBA)?|\uDC26(?:\u200D(?:\u2B1B|\uD83D\uDD25))?|\uDC3B(?:\u200D\u2744\uFE0F?)?|\uDC41\uFE0F?(?:\u200D\uD83D\uDDE8\uFE0F?)?|\uDC68(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:\uDC8B\u200D\uD83D)?\uDC68|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDC68\uDC69]\u200D\uD83D(?:\uDC66(?:\u200D\uD83D\uDC66)?|\uDC67(?:\u200D\uD83D[\uDC66\uDC67])?)|[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC66(?:\u200D\uD83D\uDC66)?|\uDC67(?:\u200D\uD83D[\uDC66\uDC67])?)|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3]))|\uD83C(?:\uDFFB(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:\uDC8B\u200D\uD83D)?\uDC68\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC68\uD83C[\uDFFC-\uDFFF])|\uD83E(?:[\uDD1D\uDEEF]\u200D\uD83D\uDC68\uD83C[\uDFFC-\uDFFF]|[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3])))?|\uDFFC(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:\uDC8B\u200D\uD83D)?\uDC68\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC68\uD83C[\uDFFB\uDFFD-\uDFFF])|\uD83E(?:[\uDD1D\uDEEF]\u200D\uD83D\uDC68\uD83C[\uDFFB\uDFFD-\uDFFF]|[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3])))?|\uDFFD(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:\uDC8B\u200D\uD83D)?\uDC68\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC68\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF])|\uD83E(?:[\uDD1D\uDEEF]\u200D\uD83D\uDC68\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3])))?|\uDFFE(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:\uDC8B\u200D\uD83D)?\uDC68\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC68\uD83C[\uDFFB-\uDFFD\uDFFF])|\uD83E(?:[\uDD1D\uDEEF]\u200D\uD83D\uDC68\uD83C[\uDFFB-\uDFFD\uDFFF]|[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3])))?|\uDFFF(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:\uDC8B\u200D\uD83D)?\uDC68\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC68\uD83C[\uDFFB-\uDFFE])|\uD83E(?:[\uDD1D\uDEEF]\u200D\uD83D\uDC68\uD83C[\uDFFB-\uDFFE]|[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3])))?))?|\uDC69(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:\uDC8B\u200D\uD83D)?[\uDC68\uDC69]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC66(?:\u200D\uD83D\uDC66)?|\uDC67(?:\u200D\uD83D[\uDC66\uDC67])?|\uDC69\u200D\uD83D(?:\uDC66(?:\u200D\uD83D\uDC66)?|\uDC67(?:\u200D\uD83D[\uDC66\uDC67])?))|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3]))|\uD83C(?:\uDFFB(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:[\uDC68\uDC69]|\uDC8B\u200D\uD83D[\uDC68\uDC69])\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC69\uD83C[\uDFFC-\uDFFF])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3]|\uDD1D\u200D\uD83D[\uDC68\uDC69]\uD83C[\uDFFC-\uDFFF]|\uDEEF\u200D\uD83D\uDC69\uD83C[\uDFFC-\uDFFF])))?|\uDFFC(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:[\uDC68\uDC69]|\uDC8B\u200D\uD83D[\uDC68\uDC69])\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC69\uD83C[\uDFFB\uDFFD-\uDFFF])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3]|\uDD1D\u200D\uD83D[\uDC68\uDC69]\uD83C[\uDFFB\uDFFD-\uDFFF]|\uDEEF\u200D\uD83D\uDC69\uD83C[\uDFFB\uDFFD-\uDFFF])))?|\uDFFD(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:[\uDC68\uDC69]|\uDC8B\u200D\uD83D[\uDC68\uDC69])\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC69\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3]|\uDD1D\u200D\uD83D[\uDC68\uDC69]\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|\uDEEF\u200D\uD83D\uDC69\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF])))?|\uDFFE(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:[\uDC68\uDC69]|\uDC8B\u200D\uD83D[\uDC68\uDC69])\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC69\uD83C[\uDFFB-\uDFFD\uDFFF])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3]|\uDD1D\u200D\uD83D[\uDC68\uDC69]\uD83C[\uDFFB-\uDFFD\uDFFF]|\uDEEF\u200D\uD83D\uDC69\uD83C[\uDFFB-\uDFFD\uDFFF])))?|\uDFFF(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D\uD83D(?:[\uDC68\uDC69]|\uDC8B\u200D\uD83D[\uDC68\uDC69])\uD83C[\uDFFB-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83D\uDC69\uD83C[\uDFFB-\uDFFE])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3]|\uDD1D\u200D\uD83D[\uDC68\uDC69]\uD83C[\uDFFB-\uDFFE]|\uDEEF\u200D\uD83D\uDC69\uD83C[\uDFFB-\uDFFE])))?))?|\uDD75(?:\uD83C[\uDFFB-\uDFFF]|\uFE0F)?(?:\u200D[\u2640\u2642]\uFE0F?)?|\uDE2E(?:\u200D\uD83D\uDCA8)?|\uDE35(?:\u200D\uD83D\uDCAB)?|\uDE36(?:\u200D\uD83C\uDF2B\uFE0F?)?|\uDE42(?:\u200D[\u2194\u2195]\uFE0F?)?|\uDEB6(?:\uD83C[\uDFFB-\uDFFF])?(?:\u200D(?:[\u2640\u2642]\uFE0F?(?:\u200D\u27A1\uFE0F?)?|\u27A1\uFE0F?))?)|\uD83E(?:[\uDD0C\uDD0F\uDD18-\uDD1F\uDD30-\uDD34\uDD36\uDD77\uDDB5\uDDB6\uDDBB\uDDD2\uDDD3\uDDD5\uDEC3-\uDEC5\uDEF0\uDEF2-\uDEF8](?:\uD83C[\uDFFB-\uDFFF])?|[\uDD26\uDD35\uDD37-\uDD39\uDD3C-\uDD3E\uDDB8\uDDB9\uDDCD\uDDCF\uDDD4\uDDD6-\uDDDD](?:\uD83C[\uDFFB-\uDFFF])?(?:\u200D[\u2640\u2642]\uFE0F?)?|[\uDDDE\uDDDF](?:\u200D[\u2640\u2642]\uFE0F?)?|[\uDD0D\uDD0E\uDD10-\uDD17\uDD20-\uDD25\uDD27-\uDD2F\uDD3A\uDD3F-\uDD45\uDD47-\uDD76\uDD78-\uDDB4\uDDB7\uDDBA\uDDBC-\uDDCC\uDDD0\uDDE0-\uDDFF\uDE70-\uDE7C\uDE80-\uDE8A\uDE8E-\uDEC2\uDEC6\uDEC8\uDECD-\uDEDC\uDEDF-\uDEEA\uDEEF]|\uDDCE(?:\uD83C[\uDFFB-\uDFFF])?(?:\u200D(?:[\u2640\u2642]\uFE0F?(?:\u200D\u27A1\uFE0F?)?|\u27A1\uFE0F?))?|\uDDD1(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\uD83C[\uDF3E\uDF73\uDF7C\uDF84\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3\uDE70]|\uDD1D\u200D\uD83E\uDDD1|\uDDD1\u200D\uD83E\uDDD2(?:\u200D\uD83E\uDDD2)?|\uDDD2(?:\u200D\uD83E\uDDD2)?))|\uD83C(?:\uDFFB(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D(?:\uD83D\uDC8B\u200D)?\uD83E\uDDD1\uD83C[\uDFFC-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF84\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83E\uDDD1\uD83C[\uDFFC-\uDFFF])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3\uDE70]|\uDD1D\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFF]|\uDEEF\u200D\uD83E\uDDD1\uD83C[\uDFFC-\uDFFF])))?|\uDFFC(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D(?:\uD83D\uDC8B\u200D)?\uD83E\uDDD1\uD83C[\uDFFB\uDFFD-\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF84\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83E\uDDD1\uD83C[\uDFFB\uDFFD-\uDFFF])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3\uDE70]|\uDD1D\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFF]|\uDEEF\u200D\uD83E\uDDD1\uD83C[\uDFFB\uDFFD-\uDFFF])))?|\uDFFD(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D(?:\uD83D\uDC8B\u200D)?\uD83E\uDDD1\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF84\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83E\uDDD1\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3\uDE70]|\uDD1D\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFF]|\uDEEF\u200D\uD83E\uDDD1\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF])))?|\uDFFE(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D(?:\uD83D\uDC8B\u200D)?\uD83E\uDDD1\uD83C[\uDFFB-\uDFFD\uDFFF]|\uD83C[\uDF3E\uDF73\uDF7C\uDF84\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFD\uDFFF])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3\uDE70]|\uDD1D\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFF]|\uDEEF\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFD\uDFFF])))?|\uDFFF(?:\u200D(?:[\u2695\u2696\u2708]\uFE0F?|\u2764\uFE0F?\u200D(?:\uD83D\uDC8B\u200D)?\uD83E\uDDD1\uD83C[\uDFFB-\uDFFE]|\uD83C[\uDF3E\uDF73\uDF7C\uDF84\uDF93\uDFA4\uDFA8\uDFEB\uDFED]|\uD83D(?:[\uDCBB\uDCBC\uDD27\uDD2C\uDE80\uDE92]|\uDC30\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFE])|\uD83E(?:[\uDDAF\uDDBC\uDDBD](?:\u200D\u27A1\uFE0F?)?|[\uDDB0-\uDDB3\uDE70]|\uDD1D\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFF]|\uDEEF\u200D\uD83E\uDDD1\uD83C[\uDFFB-\uDFFE])))?))?|\uDEF1(?:\uD83C(?:\uDFFB(?:\u200D\uD83E\uDEF2\uD83C[\uDFFC-\uDFFF])?|\uDFFC(?:\u200D\uD83E\uDEF2\uD83C[\uDFFB\uDFFD-\uDFFF])?|\uDFFD(?:\u200D\uD83E\uDEF2\uD83C[\uDFFB\uDFFC\uDFFE\uDFFF])?|\uDFFE(?:\u200D\uD83E\uDEF2\uD83C[\uDFFB-\uDFFD\uDFFF])?|\uDFFF(?:\u200D\uD83E\uDEF2\uD83C[\uDFFB-\uDFFE])?))?)/g;constructor(u,t,e,F,s){this.apiServer=u,this.sessionId=t,this.stream=e,this.perso=F,this.clientTools=s,this.resetChatState(),F.setMessageCallback("stf",u=>{if(this.setChatState(D.ChatState.SPEAKING,D.ChatState.ANALYZING),null!==this.lastStfTimeoutHandle){clearTimeout(this.lastStfTimeoutHandle);let t=Date.now();this.stfTotalDuration+=u.duration+1e3-(t-this.stfTimeoutStartTime),this.stfTimeoutStartTime=t,this.lastStfTimeoutHandle=setTimeout(()=>{this.lastStfTimeoutHandle=null,this.stfTimeoutStartTime=0,this.stfTotalDuration=0,this.setChatState(null,D.ChatState.SPEAKING)},this.stfTotalDuration)}else this.stfTimeoutStartTime=Date.now(),this.stfTotalDuration=u.duration+2e3,this.lastStfTimeoutHandle=setTimeout(()=>{this.lastStfTimeoutHandle=null,this.stfTimeoutStartTime=0,this.stfTotalDuration=0,this.setChatState(null,D.ChatState.SPEAKING)},this.stfTotalDuration)}),F.setMessageCallback("stt",u=>{if(this.setChatState(null,D.ChatState.ANALYZING),null!=this.sttEventHandler)this.sttEventHandler.dispatchEvent(new CustomEvent("stt",{detail:u.text}));else{if(""===u.text)return;this.processChat(u.text)}}),F.setMessageCallback("stt-error",u=>{this.setChatState(null,D.ChatState.ANALYZING)})}llmJob=null;async processChat(D){0!==D.trim().length&&(this.addMessageToChatLog(D,!0),this.llmJob=this.processChatInternal(D))}processCustomChat(D){0!==D.trim().length&&this.processTTSTFInternal(D)}processTTSTF(D){0!==D.trim().length&&(this.messageHistory.push({role:"assistant",type:"message",content:D}),this.addMessageToChatLog(D,!1),this.processTTSTFInternal(D))}startVoiceChat(){return this.setChatState(D.ChatState.RECORDING),this.perso.recordStart()}stopVoiceChat(){this.setChatState(D.ChatState.ANALYZING,D.ChatState.RECORDING),this.perso.recordEndStt()}changeSize(D,u){this.perso.changeSize(D,u)}async clearBuffer(){await this.clearLLMJob(),this.perso.clearBuffer(),null!==this.lastStfTimeoutHandle&&(clearTimeout(this.lastStfTimeoutHandle),this.lastStfTimeoutHandle=null),this.resetChatState()}setSrc(D){D.srcObject=this.getRemoteStream()}getLocalStream(){return this.stream}getRemoteStream(){return this.perso.getStream()}stopSession(){this.close()}onClose(D){return this.perso.subscribeStatus(u=>{null!=u.detail&&!1===u.detail.live&&D(200===u.detail.code)})}subscribeChatStates(D){const u=u=>{D(u.detail.status)};return this.chatStatesHandler.addEventListener("status",u),()=>{this.chatStatesHandler.removeEventListener("status",u)}}subscribeChatLog(D){const u=u=>{D(u.detail.chatLog)};return this.chatLogHandler.addEventListener("chatLog",u),()=>{this.chatLogHandler.removeEventListener("chatLog",u)}}setSttResultCallback(D){const u=u=>{D(u.detail)};return this.sttEventHandler=new EventTarget,this.sttEventHandler.addEventListener("stt",u),()=>{this.sttEventHandler?.removeEventListener("stt",u),this.sttEventHandler=null}}setErrorHandler(D){const u=u=>{D(u.detail.error)};return this.errorHandler.addEventListener("error",u),()=>{this.errorHandler.removeEventListener("error",u)}}getSessionId(){return this.sessionId}async processChatInternal(u){this.setChatState(D.ChatState.LLM);const s=this.clientTools.map(D=>({type:"function",function:{description:D.description,name:D.name,parameters:D.parameters}})),a=new Array;null===u||(u instanceof Array?a.push(...u):"string"==typeof u&&a.push({role:"user",content:u}));const C=await fetch(`${this.apiServer}/api/v1/session/${this.sessionId}/llm/v2/`,{body:JSON.stringify({messages:[...this.messageHistory,...a],tools:s}),headers:{"Content-Type":"application/json"},method:"POST"});if(!C.ok){const u=await C.json(),F=new e(new t(C.status,u.errors[0].code,u.errors[0].detail,u.errors[0].attr));return this.setError(F),void this.setChatState(null,D.ChatState.LLM)}const n=C.body?.getReader(),i=new TextDecoder("utf-8");let E="",r=null,o="";for(;;){const{done:u,value:t}=await n.read();if(u)break;let s;for(o+=i.decode(t,{stream:!0});-1!==(s=o.indexOf("\n"));){if(this.llmCancel)return E.length>0&&this.addMessageToChatLog(E,!1),void this.setChatState(null,D.ChatState.LLM);const u=o.slice(0,s).trim();if(o=o.slice(s+1),!u.startsWith("data: {")){const u=new e(new F("Failed to parse SSE response"));return this.setError(u),void this.setChatState(null,D.ChatState.LLM)}const t=JSON.parse(u.slice(6).trim());if("success"!==t.status){const u=new e(new F(t.reason));return this.setError(u),void this.setChatState(null,D.ChatState.LLM)}E.length>0&&"message"!=t.type&&(a.push({role:"assistant",type:"message",content:E}),this.addMessageToChatLog(E,!1),E=""),"message"!==t.type?"tool_call"!==t.type||null==t.tool_calls?"tool"!==t.role||"tool_call"===t.type&&a.push({role:t.role,type:t.type,content:t.content,tool_call_id:t.tool_call_id}):(a.push({role:"assistant",type:t.type,content:t.content,tool_calls:t.tool_calls}),r=t):(E+=t.content,this.processTTSTFInternal(t.content))}}if(this.llmCancel)this.setChatState(null,D.ChatState.LLM);else{if(null!=r){const D=[];for(const u of r.tool_calls){const t=this.getChatTool(this.clientTools,u.function.name);null!=t&&D.push(new Promise(async D=>{try{const e=await t.call(JSON.parse(u.function.arguments));D({toolCallId:u.id,chatTool:t,chatToolResult:e})}catch(e){D({toolCallId:u.id,chatTool:t,chatToolResult:{result:"error!"}})}}))}const u=await Promise.all(D);for(const D of u)a.push({role:"tool",content:JSON.stringify(D.chatToolResult),tool_call_id:D.toolCallId});const t=u.length>0&&r.tool_calls.length!==u.length,e=u.some(D=>!D.chatTool.executeOnly);t||e?await this.processChatInternal(a):this.messageHistory.push(...a)}else this.messageHistory.push(...a);this.setChatState(null,D.ChatState.LLM)}}getChatTool(D,u){for(const t of D)if(t.name===u)return t;return null}llmCancel=!1;async clearLLMJob(){null!=this.llmJob&&(this.llmCancel=!0,await this.llmJob,this.llmCancel=!1)}processTTSTFInternal(u){const t=this.removeEmoji(u).trim();0!==t.length&&(this.setChatState(D.ChatState.ANALYZING),this.perso.ttstf(t))}addMessageToChatLog(D,u){this.chatLog=[{text:D,isUser:u,timestamp:new Date},...this.chatLog],this.chatLogHandler.dispatchEvent(new CustomEvent("chatLog",{detail:{chatLog:this.chatLog}}))}setChatState(u=null,t=null){const e=new Map(this.chatStateMap);function F(u){u===D.ChatState.ANALYZING?e.set(u,(e.get(u)||0)+1):e.set(u,1)}function s(u){u===D.ChatState.ANALYZING?e.set(u,Math.max((e.get(u)||0)-1,0)):e.set(u,0)}if(null!=u)if(u instanceof Array)for(let D of u)F(D);else F(u);if(null!=t)if(t instanceof Array)for(let D of t)s(D);else s(t);const a=this.exchangeChatStateMapToSet(this.chatStateMap),C=this.exchangeChatStateMapToSet(e);this.chatStateMap=e,this.isEqualChatStateMap(a,C)||this.dispatchChatState(C)}resetChatState(){this.chatStateMap=new Map([[D.ChatState.RECORDING,0],[D.ChatState.LLM,0],[D.ChatState.ANALYZING,0],[D.ChatState.SPEAKING,0]]),this.dispatchChatState(this.exchangeChatStateMapToSet(this.chatStateMap))}exchangeChatStateMapToSet(D){const u=new Set;for(const t of D)t[1]>0&&u.add(t[0]);return u}dispatchChatState(D){this.chatStatesHandler.dispatchEvent(new CustomEvent("status",{detail:{status:D}}))}isEqualChatStateMap(D,u){if(D.size!==u.size)return!1;for(const t of D)if(D.has(t)!==u.has(t))return!1;return!0}setError(D){this.errorHandler.dispatchEvent(new CustomEvent("error",{detail:{error:D}}))}close(){this.perso.closeSelf()}removeEmoji(D){return D.replace(this.emojiRegex,"")}}async function i(D,u){return await s.getLLMs(D,u)}async function E(D,u){return await s.getTTSs(D,u)}async function r(D,u){return await s.getSTTs(D,u)}async function o(D,u){return await s.getModelStyles(D,u)}async function c(D,u){return await s.getBackgroundImages(D,u)}async function l(D,u){return await s.getPrompts(D,u)}async function h(D,u){return await s.getDocuments(D,u)}async function B(D,u){return await s.getMcpServers(D,u)}const d=async(D,u,t)=>{const e={capability:[],...t};t.using_stf_webrtc&&e.capability.push("STF_WEBRTC"),t?.llm_type&&(e.capability.push("LLM"),e.llm_type=t.llm_type),t?.tts_type&&(e.capability.push("TTS"),e.tts_type=t.tts_type),t?.stt_type&&(e.capability.push("STT"),e.stt_type=t.stt_type);const F=await fetch(`${D}/api/v1/session/`,{body:JSON.stringify(e),headers:{"PersoLive-APIKey":u,"Content-Type":"application/json"},method:"POST"});return(await s.parseJson(F)).session_id};return D.ApiError=t,D.ChatTool=class{name;description;parameters;call;executeOnly;constructor(D,u,t,e,F=!1){this.name=D,this.description=u,this.parameters=t,this.call=e,this.executeOnly=F}},D.LLMError=e,D.LLMStreamingResponseError=F,D.Session=n,D.createSession=async function(D,u,t,e,F,s){return await(async(D,u,t,e,F,s)=>{let a=null,i=null;if(F)a=await navigator.mediaDevices.getUserMedia({audio:!0,video:!1}),i=()=>{};else{const D=new AudioContext,u=D.createOscillator();u.frequency.value=0;const t=D.createMediaStreamDestination();u.connect(t),u.start(),a=t.stream,i=()=>{u.stop(),u.disconnect(t)}}const E=await C.create(D,u,a,t,e),r=new n(D,u,a,E,s);return r.onClose(D=>{i()}),r})(D,u,t,e,F,s)},D.createSessionId=d,D.getAllSettings=async function(D,u){const t=await i(D,u),e=await o(D,u),F=await c(D,u);return{llms:t,ttsTypes:await E(D,u),sttTypes:await r(D,u),modelStyles:e,backgroundImages:F,prompts:await l(D,u),documents:await h(D,u),mcpServers:await B(D,u)}},D.getBackgroundImages=c,D.getDocuments=h,D.getLLMs=i,D.getMcpServers=B,D.getModelStyles=o,D.getPrompts=l,D.getSTTs=r,D.getSessionInfo=async function(D,u){return await s.getSessionInfo(D,u)},D.getTTSs=E,D}({});
